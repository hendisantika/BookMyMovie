<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <title>Pick Your Seats - BookMyMovie</title>
    <link href="/favicon.svg" rel="icon" type="image/svg+xml"/>
    <link href="/images/ticket-icon.svg" rel="apple-touch-icon"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="css/site.css" rel="stylesheet"/>
</head>
<body>
<nav class="navbar">
    <div class="container">
        <a class="navbar-brand" href="/movies">
            <img alt="BookMyMovie" height="32" src="/images/ticket-icon.svg" width="32"/>
            <span>BookMyMovie</span>
        </a>
        <ul class="nav">
            <li><a href="/movies">Home</a></li>
            <li><a href="/movies">Movies</a></li>
            <li><a href="/theatres">Theatres</a></li>
        </ul>
        <ul class="nav">
            <li sec:authorize="isAnonymous()">
                <a href="/login">
                    <svg fill="currentColor" height="16" style="vertical-align: middle; margin-right: 4px;" viewBox="0 0 16 16"
                         width="16">
                        <path d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"
                              fill-rule="evenodd"/>
                        <path d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"
                              fill-rule="evenodd"/>
                    </svg>
                    Login
                </a>
            </li>
            <li sec:authorize="isAuthenticated()">
                <a href="/logout">
                    <svg fill="currentColor" height="16" style="vertical-align: middle; margin-right: 4px;" viewBox="0 0 16 16"
                         width="16">
                        <path d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"
                              fill-rule="evenodd"/>
                        <path d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"
                              fill-rule="evenodd"/>
                    </svg>
                    Logout
                </a>
            </li>
        </ul>
    </div>
</nav>

<div class="container">
    <!-- Movie Details Card -->
    <div class="card" style="margin: var(--spacing-xl) 0;">
        <div style="display: grid; grid-template-columns: 200px 1fr; gap: var(--spacing-lg); align-items: start;">
            <!-- Movie Poster -->
            <div>
                <img alt="Movie Poster" style="width: 100%; border-radius: var(--radius-md); box-shadow: var(--shadow-md);"
                     th:src="${moviePoster}"/>
            </div>

            <!-- Movie and Screening Info -->
            <div>
                <h2 style="margin: 0 0 var(--spacing-md) 0; background: var(--gradient-cinema);
                           -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"
                    th:text="${movieName}">Movie Name</h2>

                <div style="display: grid; gap: var(--spacing-sm);">
                    <!-- Theatre -->
                    <div style="display: flex; align-items: center; color: var(--text-secondary);">
                        <svg fill="currentColor" height="20" style="margin-right: var(--spacing-sm);"
                             viewBox="0 0 16 16" width="20">
                            <path d="M6.5 14.5v-3.505c0-.245.25-.495.5-.495h2c.25 0 .5.25.5.5v3.5a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5z"/>
                        </svg>
                        <strong>Theatre:</strong>&nbsp;<span th:text="${theatreName} + ', ' + ${theatreCity}">Theatre Name</span>
                    </div>

                    <!-- Date -->
                    <div style="display: flex; align-items: center; color: var(--text-secondary);">
                        <svg fill="currentColor" height="20" style="margin-right: var(--spacing-sm);"
                             viewBox="0 0 16 16" width="20">
                            <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                        </svg>
                        <strong>Date:</strong>&nbsp;<span th:text="${screeningDate}">Date</span>
                    </div>

                    <!-- Time -->
                    <div style="display: flex; align-items: center; color: var(--text-secondary);">
                        <svg fill="currentColor" height="20" style="margin-right: var(--spacing-sm);"
                             viewBox="0 0 16 16" width="20">
                            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                        </svg>
                        <strong>Time:</strong>&nbsp;<span th:text="${screeningTime}">Time</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seat Selection Section -->
    <div class="card">
        <h3 style="text-align: center; color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
            Select Your Seats
        </h3>

        <!-- Screen Indicator -->
        <div style="text-align: center; margin-bottom: var(--spacing-xl);">
            <div style="width: 80%; margin: 0 auto; padding: var(--spacing-sm); background: linear-gradient(to bottom, #333, #000);
                        border-radius: var(--radius-md) var(--radius-md) 50% 50%; color: #fff; font-weight: 600;">
                SCREEN
            </div>
        </div>

        <!-- Seat Legend -->
        <div style="display: flex; justify-content: center; gap: var(--spacing-lg); margin-bottom: var(--spacing-lg); flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: var(--spacing-xs);">
                <div style="width: 32px; height: 32px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: #fff;"></div>
                <span>Available</span>
            </div>
            <div style="display: flex; align-items: center; gap: var(--spacing-xs);">
                <div style="width: 32px; height: 32px; border: 2px solid var(--primary); border-radius: var(--radius-sm); background: var(--primary);"></div>
                <span>Selected</span>
            </div>
            <div style="display: flex; align-items: center; gap: var(--spacing-xs);">
                <div style="width: 32px; height: 32px; border: 2px solid #ccc; border-radius: var(--radius-sm); background: #e0e0e0; opacity: 0.5;"></div>
                <span>Booked</span>
            </div>
        </div>

        <!-- Seat Grid -->
        <div id="seatMap" style="max-width: 700px; margin: 0 auto var(--spacing-xl) auto;">
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: var(--spacing-sm);"
                 th:each="row : ${seatsByRow}">
                <!-- Row Label -->
                <div style="width: 40px; text-align: center; font-weight: 600; color: var(--text-secondary);"
                     th:text="${row.key}">A
                </div>

                <!-- Seats in Row -->
                <div style="display: flex; gap: var(--spacing-xs);">
                    <button class="seat"
                            style="width: 42px; height: 42px; border: 2px solid var(--border); border-radius: var(--radius-sm);
                                   background: #fff; cursor: pointer; font-weight: 500; transition: all 0.2s ease;"
                            th:attr="data-seat-id=${seat.seatId}, data-row=${seat.rowId}, data-number=${seat.seatRowNumber}"
                            th:classappend="${bookedSeatIds.contains(seat.seatId)} ? 'seat booked' : 'seat available'"
                            th:disabled="${bookedSeatIds.contains(seat.seatId)}"
                            th:each="seat : ${row.value}"
                            th:text="${seat.seatRowNumber}">
                        1
                    </button>
                </div>
            </div>
        </div>

        <!-- Selected Seats Summary -->
        <div id="selectionSummary"
             style="text-align: center; padding: var(--spacing-lg); background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
            <p style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.95rem; color: var(--text-secondary);">
                Selected Seats: <strong id="selectedSeats">None</strong>
            </p>
            <p style="margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--primary);">
                Total Seats: <span id="seatCount">0</span>
            </p>
        </div>

        <!-- Continue Button -->
        <div style="text-align: center;">
            <button disabled id="continueBtn"
                    style="padding: var(--spacing-md) var(--spacing-xl); background: var(--primary); color: white;
                           border: none; border-radius: var(--radius-md); font-size: 1rem; font-weight: 600;
                           cursor: not-allowed; opacity: 0.5; transition: all 0.3s ease;">
                Continue to Payment
            </button>
        </div>

        <div class="booking-success"
             style="display: none; text-align: center; padding: var(--spacing-lg); background: #d4edda; border: 1px solid #c3e6cb; border-radius: var(--radius-md); color: #155724; margin-top: var(--spacing-lg);">
            <p style="margin: 0;">
                <strong>Success!</strong> Enjoy the show!
            </p>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <p class="text-muted">Â© 2025 BookMyMovie. All rights reserved.</p>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="/js/site.js"></script>

<script>
    $(document).ready(function () {
        const selectedSeats = new Set();
        const screeningId = [[${screeningId}]];

        // Handle seat selection
        $('.seat.available').on('click', function () {
            const $seat = $(this);
            const seatId = $seat.data('seat-id');
            const row = $seat.data('row');
            const number = $seat.data('number');
            const seatLabel = row + number;

            if ($seat.hasClass('selected')) {
                // Deselect
                $seat.removeClass('selected');
                $seat.css({
                    'background': '#fff',
                    'border-color': 'var(--border)',
                    'transform': 'scale(1)'
                });
                selectedSeats.delete(seatId);
            } else {
                // Select
                $seat.addClass('selected');
                $seat.css({
                    'background': 'var(--primary)',
                    'color': '#fff',
                    'border-color': 'var(--primary)',
                    'transform': 'scale(1.1)'
                });
                selectedSeats.add(seatId);
            }

            updateSelection();
        });

        // Update selection summary
        function updateSelection() {
            const count = selectedSeats.size;
            const seatLabels = $('.seat.selected').map(function () {
                return $(this).data('row') + $(this).data('number');
            }).get().join(', ');

            $('#seatCount').text(count);
            $('#selectedSeats').text(count > 0 ? seatLabels : 'None');

            // Enable/disable continue button
            const $btn = $('#continueBtn');
            if (count > 0) {
                $btn.prop('disabled', false);
                $btn.css({
                    'cursor': 'pointer',
                    'opacity': '1'
                });
            } else {
                $btn.prop('disabled', true);
                $btn.css({
                    'cursor': 'not-allowed',
                    'opacity': '0.5'
                });
            }
        }

        // Style booked seats
        $('.seat.booked').css({
            'background': '#e0e0e0',
            'border-color': '#ccc',
            'opacity': '0.5',
            'cursor': 'not-allowed'
        });

        // Handle continue button click
        $('#continueBtn').on('click', function () {
            if (selectedSeats.size === 0) {
                alert('Please select at least one seat');
                return;
            }

            const $btn = $(this);
            const originalText = $btn.text();

            // Disable button and show loading state
            $btn.prop('disabled', true);
            $btn.text('Booking...');
            $btn.css({'opacity': '0.7', 'cursor': 'not-allowed'});

            const seatIds = Array.from(selectedSeats);

            // Send booking request to server
            $.ajax({
                url: '/seats/book',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    screeningId: screeningId,
                    seatIds: seatIds
                }),
                success: function (response) {
                    console.log('Booking successful:', response);

                    // Show success message
                    $('.booking-success').fadeIn();
                    setTimeout(function () {
                        window.location.href = '/movies';
                    }, 2000);
                },
                error: function (xhr, status, error) {
                    console.error('Booking failed:', xhr.responseJSON || error);

                    let errorMessage = 'Failed to book seats. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }

                    alert(errorMessage);

                    // Re-enable button
                    $btn.prop('disabled', false);
                    $btn.text(originalText);
                    $btn.css({'opacity': '1', 'cursor': 'pointer'});

                    // If seats were already booked, reload the page to refresh seat availability
                    if (xhr.status === 409) {
                        setTimeout(function () {
                            location.reload();
                        }, 1500);
                    }
                }
            });
        });
    });
</script>

</body>
</html>